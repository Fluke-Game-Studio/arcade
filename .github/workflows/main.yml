name: Deploy to Namecheap (build + rsync)

on:
  push:
    branches: ["main", "dev", "qa"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ----------------------------
      # Build (edit APP_DIR/DIST_DIR if needed)
      # ----------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        env:
          APP_DIR: "."     # change if your app is in a subfolder (e.g. "my-app")
        run: |
          cd "$APP_DIR"
          npm ci

      - name: Build
        env:
          APP_DIR: "."     # change if your app is in a subfolder (e.g. "my-app")
        run: |
          cd "$APP_DIR"
          npm run build

      - name: Ensure build output exists
        env:
          APP_DIR: "."
          DIST_DIR: "dist" # change if your build output is "build"
        run: |
          test -d "${APP_DIR}/${DIST_DIR}" || (echo "Build output not found at ${APP_DIR}/${DIST_DIR}" && ls -la "${APP_DIR}" && exit 1)
          echo "Build output:"
          ls -la "${APP_DIR}/${DIST_DIR}"

      # ----------------------------
      # SSH setup
      # ----------------------------
      - name: Install SSH key from base64
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SFTP_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Verify deploy key fingerprint (must be cyglfMd...)
        run: |
          ssh-keygen -y -f ~/.ssh/deploy_key | ssh-keygen -lf -

      # ----------------------------
      # Target folder mapping
      # prod: arcade.flukegamestudio.com
      # dev : arcade.flukegamestudio.com/dev
      # qa  : arcade.flukegamestudio.com/qa
      # ----------------------------
      - name: Choose remote folder
        id: target
        run: |
          case "${{ github.ref_name }}" in
            main) echo "REMOTE_DIR=arcade.flukegamestudio.com" >> $GITHUB_OUTPUT ;;
            dev)  echo "REMOTE_DIR=arcade.flukegamestudio.com/dev" >> $GITHUB_OUTPUT ;;
            qa)   echo "REMOTE_DIR=arcade.flukegamestudio.com/qa" >> $GITHUB_OUTPUT ;;
            *)    echo "REMOTE_DIR=arcade.flukegamestudio.com" >> $GITHUB_OUTPUT ;;
          esac

      - name: Print deploy target
        run: |
          echo "BRANCH=${{ github.ref_name }}"
          echo "REMOTE_DIR=${{ steps.target.outputs.REMOTE_DIR }}"

      - name: SSH preflight + ensure remote dir exists
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          REMOTE_DIR: ${{ steps.target.outputs.REMOTE_DIR }}
        run: |
          ssh -p "$SFTP_PORT" \
            -i ~/.ssh/deploy_key \
            -o IdentitiesOnly=yes \
            -o PreferredAuthentications=publickey \
            -o PasswordAuthentication=no \
            -o KbdInteractiveAuthentication=no \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "$SFTP_USER@$SFTP_HOST" \
            "echo SSH_OK && whoami && pwd && mkdir -p ~/${REMOTE_DIR} && ls -la ~/${REMOTE_DIR}"

      # ----------------------------
      # Deploy build output (NO deletions)
      # ----------------------------
      - name: Rsync deploy build output (replace/update only)
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          REMOTE_DIR: ${{ steps.target.outputs.REMOTE_DIR }}
          APP_DIR: "."
          DIST_DIR: "dist"
        run: |
          set -e

          SRC="${APP_DIR}/${DIST_DIR}/"
          echo "Deploying from: ${SRC}"
          echo "Deploying to: ${SFTP_USER}@${SFTP_HOST}:~/${REMOTE_DIR}/"

          rsync -az \
            -e "ssh -p ${SFTP_PORT} -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            "${SRC}" "${SFTP_USER}@${SFTP_HOST}:~/${REMOTE_DIR}/"
